<!DOCTYPE html>

<html lang="en">

<head>

    <meta charset="UTF-8">

    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <title>Construction 21</title>

    <link rel="icon" href="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI2NCIgaGVpZ2h0PSI2NCIgdmlld0JveD0iMCAwIDI0IDI0IiBmaWxsPSJub25lIiBzdHJva2U9IiNlMGExMDYiIHN0cm9rZS13aWR0aD0iMiIgc3Ryb2tlLWxpbmVjYXA9InJvdW5kIiBzdHJva2UtbGluZWpvaW49InJvdW5kIj48cGF0aCBkPSJNMTUuMDUgNWEzIDMgMCAwIDEgNC41IDBIM15NMTUuMDUgNU0xOSA4LjVjMCAxLjUtLjUgMy41LTIgNC41di4wNUgxN2EyIDIgMCAwIDAgLTIgLTIgYSAyIDIgMCAwIDAgLTIgMkgxM3YtNkgxNlY4LjVNOSA2LjVWNE02IDcgTDUuNSAxNC41TWwwIDE1IDguOTkgMy04IGMxLjUgLTRoMmMwIDAuNSAwLjUgMSAwLjUgMnYxSDEwdjNjMCAxIDAgMi40IC0xIDN2XzIgYzAgMC41IDAuMiAwLjUgMC41IDAuNXMwLjUgLTAuMiAwLjUgLTAuNVYyMUg0LjA3bDEuOCAtMTQuMjUgYTEgMSAwIDAgMSAwLjE5IC0wLjA3IHoiLz48L3N2Zz4=" type="image/svg+xml">

    <!--

    NOTE: For production, you should install Tailwind CSS properly:

    1. Use npm: npm install tailwindcss postcss autoprefixer

    2. Initialize: npx tailwindcss init

    3. Configure tailwind.config.js and postcss.config.js

    4. Use the CLI to build a production CSS file: npx tailwindcss -i ./src/input.css -o ./dist/output.css

   

    See https://tailwindcss.com/docs/installation for detailed instructions

    This CDN version is fine for development but not recommended for production.

    -->

    <script src="https://cdn.tailwindcss.com"></script>

    <style>

        body {

            margin: 0;

            padding: 0;

            background: radial-gradient(ellipse at 60% 40%, #ffd70033 0%, #23232b 100%), linear-gradient(135deg, #23232b 0%, #2d2d3a 100%);

            font-family: 'Segoe UI', Arial, sans-serif;

            min-height: 100vh;

            color: #EAEAEA;

        }

        .animated-bg {

            position: fixed; inset: 0; z-index: -1; pointer-events: none; overflow: hidden;

        }

        .bg-shape {

            position: absolute; border-radius: 50%; opacity: 0.18; filter: blur(18px); animation: floatBg 8s ease-in-out infinite alternate;

        }

        .bg-shape1 { width: 340px; height: 340px; background: #ffd700; left: 8vw; top: 10vh; animation-delay: 0s; }

        .bg-shape2 { width: 220px; height: 220px; background: #ff4e00; right: 10vw; top: 30vh; animation-delay: 2s; }

        .bg-shape3 { width: 180px; height: 180px; background: #00cfff; left: 30vw; bottom: 8vh; animation-delay: 4s; }

        @keyframes floatBg {

            0% { transform: translateY(0) scale(1); }

            100% { transform: translateY(-25px) scale(1.05); }

        }

        #game-container {

            width: 100%; max-width: 800px; margin: 0 auto; padding: 20px;

        }

        .card-table {

            display: flex; flex-direction: column; gap: 30px; padding: 20px;

            background: linear-gradient(135deg, #05392d 0%, #083f2e 100%);

            border-radius: 15px;

            box-shadow: inset 0 0 40px rgba(0, 0, 0, 0.3), 0 10px 30px rgba(0, 0, 0, 0.5);

            border: 6px solid #05392d;

        }

        .dealer-area, .player-area {

            display: flex; flex-direction: column; align-items: center;

            background: rgba(0,0,0,0.15); padding: 20px; border-radius: 12px;

            box-shadow: inset 0 0 15px rgba(0,0,0,0.2);

        }

        .hand-label {

            color: white; font-size: 18px; margin-bottom: 12px; font-weight: bold;

            text-shadow: 0 2px 4px rgba(0,0,0,0.3); background: rgba(255,215,0,0.15);

            padding: 5px 15px; border-radius: 20px; box-shadow: 0 2px 5px rgba(0,0,0,0.2);

        }

        .cards {

            display: flex; flex-wrap: wrap; justify-content: center; gap: 15px; min-height: 180px; align-items: center; padding: 10px;

        }

        .card {

            width: 120px; height: 170px; background: white; border-radius: 12px;

            box-shadow: 0 4px 15px rgba(0,0,0,0.25); position: relative;

            transform-style: preserve-3d;

            transition: transform 0.6s cubic-bezier(0.4, 0, 0.2, 1);

        }

        .card.hidden {

            transform: rotateY(180deg);

        }

        .card .card-face, .card .card-back {

            position: absolute; width: 100%; height: 100%;

            backface-visibility: hidden; -webkit-backface-visibility: hidden;

            border-radius: 12px;

        }

        .card .card-face {

            display: flex; flex-direction: column; justify-content: space-between;

            box-sizing: border-box; padding: 10px; background: white;

            border: 1px solid #e0e0e0;

        }

        .card.red .card-face { color: #e63946; }

        .card.black .card-face { color: #1d3557; }

        .card .card-back {

            background: repeating-linear-gradient(135deg, #0a4d68, #0a4d68 10px, #088395 10px, #088395 20px);

            transform: rotateY(180deg); display: flex; align-items: center; justify-content: center;

        }

        .card .card-back::after { content: "🔨"; font-size: 50px; color: rgba(255, 255, 255, 0.85); text-shadow: 0 0 5px rgba(0, 0, 0, 0.3); }

        .card .corner { display: flex; flex-direction: column; align-items: center; font-weight: bold; line-height: 1; }

        .card .top-left { align-self: flex-start; }

        .card .bottom-right { align-self: flex-end; transform: rotate(180deg); }

        .card .value { font-size: 22px; }

        .card .suit { font-size: 24px; }

        .card .center-suit, .card .face-design { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); }

        .card .center-suit { font-size: 60px; }

        .card .face-design { font-size: 48px; }

        .card .face-K::after { content: '👷‍♂️'; }

        .card .face-Q::after { content: '👷‍♀️'; }

        .card .face-J::after { content: '🏗️'; }

        .card .face-A { font-size: 72px; }

        @keyframes dealCard {

            from { transform: translateY(-300px) translateX(400px) rotate(180deg) scale(0.3); opacity: 0; }

            to { transform: translateY(0) translateX(0) rotate(0deg) scale(1); opacity: 1; }

        }

        .card.dealing { animation: dealCard 0.5s cubic-bezier(0.215, 0.61, 0.355, 1) forwards; }

        .control-btn, .auth-btn, .primary-btn, .secondary-btn {

            padding: 12px 24px; border-radius: 8px; font-size: 16px; font-weight: bold;

            cursor: pointer; transition: all 0.2s; border: none;

        }

        .control-btn:disabled { background: #9ca3af; cursor: not-allowed; transform: none; box-shadow: none; opacity: 0.6; }

        .chip {

            width: 60px; height: 60px; border-radius: 50%; display: flex; align-items: center; justify-content: center;

            font-weight: bold; font-size: 18px; color: white; margin: 5px; cursor: pointer;

            box-shadow: 0 4px 8px rgba(0,0,0,0.3); position: relative; text-shadow: 0 1px 2px rgba(0,0,0,0.5);

            border: 2px solid rgba(255,255,255,0.3); transition: transform 0.15s, box-shadow 0.15s;

        }

        .chip:hover { transform: translateY(-3px); box-shadow: 0 6px 12px rgba(0,0,0,0.4); }

        .chip-5 { background: linear-gradient(135deg, #f55 0%, #900 100%); }

        .chip-10 { background: linear-gradient(135deg, #55f 0%, #006 100%); }

        .chip-25 { background: linear-gradient(135deg, #5f5 0%, #060 100%); }

        .chip-100 { background: linear-gradient(135deg, #000 0%, #333 100%); }

        #game-result-screen {

            position: absolute; top: 0; left: 0; width: 100%; height: 100%;

            background: rgba(30, 41, 59, 0.95); backdrop-filter: blur(5px);

            z-index: 20; display: flex; flex-direction: column; align-items: center; justify-content: center;

            gap: 1.5rem; opacity: 0; pointer-events: none; transition: opacity 0.4s;

            border-radius: 15px;

        }

        #game-result-screen.active { opacity: 1; pointer-events: all; }

        #leaderboard {

             background: rgba(17, 24, 39, 0.8);

             backdrop-filter: blur(5px);

             border: 1px solid rgba(255,255,255,0.1);

        }

        .auth-tab-content { display: none; }

        .auth-tab-content.active { display: block; }

        .auth-tab-btn.active { background-color: #4f46e5; color: white; }

    </style>

</head>

<body class="bg-gray-900 text-white">

    <div class="animated-bg">

        <div class="bg-shape bg-shape1"></div>

        <div class="bg-shape bg-shape2"></div>

        <div class="bg-shape bg-shape3"></div>

    </div>



    <div id="game-container" class="p-4 mx-auto max-w-4xl">

        <h1 class="text-4xl font-bold text-center text-yellow-400 mb-4">🔨 Construction 21 🔨</h1>



        <!-- Main Menu -->

        <div id="main-menu" class="bg-gray-800 p-6 rounded-lg shadow-lg text-center">

            <div id="auth-section">

                 <!-- Auth content will be injected by JS -->

            </div>

            <div id="user-profile" class="hidden">

                <h3 class="text-2xl mb-2">Welcome, <span id="profile-name" class="font-bold text-yellow-400"></span>!</h3>

                <div class="text-lg mb-4">Your Chips: <span id="profile-chips" class="font-bold"></span></div>

                <button id="play-btn" class="primary-btn bg-blue-600 hover:bg-blue-700 text-white w-full sm:w-auto">Play Game</button>

                <button id="logout-btn" class="secondary-btn bg-gray-600 hover:bg-gray-700 text-white w-full sm:w-auto mt-2 sm:mt-0 sm:ml-2">Logout</button>

            </div>

        </div>



        <!-- Game Canvas -->

        <div id="game-canvas" class="hidden mt-4">

            <div class="card-table">

                <div class="dealer-area">

                    <div class="hand-label">Dealer's Hand: <span id="dealer-score">0</span></div>

                    <div id="dealer-cards" class="cards"></div>

                </div>

               

                <div class="player-area">

                    <div class="hand-label">Your Hand: <span id="player-score">0</span></div>

                    <div id="player-hands-display" class="cards"></div>

                </div>

               

                <div id="betting-controls" class="mt-4 space-y-2">

                    <h3 class="text-lg font-semibold">Place Your Bets</h3>

                    <div class="flex items-center space-x-2">

                        <label for="bet-amount" class="text-sm">Main Bet:</label>

                        <input type="number" id="bet-amount" value="10" min="1" class="p-1 border rounded w-20 text-black">

                        <span class="text-sm">Current: <span id="current-bet">0</span></span>

                    </div>

                    <!-- Side Bet Inputs -->

                    <div class="flex items-center space-x-2">

                        <label for="perfect-pairs-bet" class="text-sm">Perfect Pairs:</label>

                        <input type="number" id="perfect-pairs-bet" value="0" min="0" class="p-1 border rounded w-20 text-black">

                        <span class="text-sm">Current: <span id="current-pp-bet">0</span></span>

                    </div>

                    <div class="flex items-center space-x-2">

                        <label for="twenty-one-plus-three-bet" class="text-sm">21+3:</label>

                        <input type="number" id="twenty-one-plus-three-bet" value="0" min="0" class="p-1 border rounded w-20 text-black">

                        <span class="text-sm">Current: <span id="current-21plus3-bet">0</span></span>

                    </div>

                    <button id="place-bet-btn" class="bg-green-500 hover:bg-green-700 text-white font-bold py-2 px-4 rounded">Place Bet</button>

                </div>



                <div id="game-area" class="hidden mt-4">

                    <h2 class="text-xl font-bold">Dealer\'s Hand</h2>

                    <div id="dealer-score" class="text-lg">Score: 0</div>

                    <div id="dealer-cards" class="flex space-x-2 mt-2 min-h-[100px]">

                        <!-- Dealer cards will be added here -->

                    </div>



                    <h2 class="text-xl font-bold mt-4">Your Hand(s)</h2>

                    <!-- Placeholder for side bet results -->

                    <div id="side-bet-results" class="hidden my-2 p-2 border rounded bg-blue-100 text-blue-800">

                        <!-- Side bet results will be shown here -->

                    </div>

                    <!-- Container for multiple player hands -->

                    <div id="player-hands-display" class="mt-2 space-y-4">

                        <!-- Player hands will be dynamically created here by JS -->

                        <!-- Example structure for a single hand (to be replicated by JS):

                        <div class="player-hand border p-2 rounded">

                            <div class="player-score text-lg">Score: 0</div>

                            <div class="player-cards flex space-x-2 mt-2 min-h-[100px]">

                                Player cards

                            </div>

                            <div class="hand-status text-sm italic"></div>

                        </div>

                        -->

                    </div>

                   

                    <div id="game-controls" class="mt-4 space-x-2 hidden">

                        <button id="hit-btn" class="bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded">Hit</button>

                        <button id="stand-btn" class="bg-yellow-500 hover:bg-yellow-700 text-white font-bold py-2 px-4 rounded">Stand</button>

                        <button id="split-btn" class="bg-purple-500 hover:bg-purple-700 text-white font-bold py-2 px-4 rounded hidden">Split</button>

                        <!-- Double Down button will be added here later -->

                    </div>

                </div>

            </div>



            <!-- Result Screen -->

            <div id="game-result-screen">

                <h2 id="result-message" class="text-4xl font-bold text-yellow-400">You Win!</h2>

                <div class="text-2xl">Final Chips: <span id="final-chips" class="font-bold">0</span></div>

                <div>

                    <button id="play-again-btn" class="primary-btn bg-blue-600 hover:bg-blue-700 text-white">Play Again</button>

                    <button id="return-menu-btn" class="secondary-btn bg-gray-600 hover:bg-gray-700 text-white ml-2">Main Menu</button>

                </div>

            </div>

        </div>

       

        <!-- Leaderboard -->

        <div id="leaderboard" class="mt-6 p-4 rounded-lg shadow-lg hidden">

            <h2 class="text-2xl font-bold text-center mb-4 text-yellow-400">Top Players</h2>

            <ul id="leaderboard-entries" class="space-y-2">

                <!-- Entries populated by JS -->

            </ul>

        </div>

    </div>



    <script type="module">

        // Firebase Imports - Using latest modular SDK

        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";

        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";

        import { getFirestore, doc, getDoc, setDoc, updateDoc, collection, query, getDocs, limit, orderBy as firestoreOrderBy } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

       

        // --- DOM Elements ---

        const mainMenu = document.getElementById('main-menu');

        const gameCanvas = document.getElementById('game-canvas');

        const leaderboardDiv = document.getElementById('leaderboard');

        const authSection = document.getElementById('auth-section');

        const userProfile = document.getElementById('user-profile');

        const dealerCardsEl = document.getElementById('dealer-cards');

        const playerCardsEl = document.getElementById('player-cards');

        const dealerScoreEl = document.getElementById('dealer-score');

        const playerScoreEl = document.getElementById('player-score');

        const bettingControls = document.getElementById('betting-controls');

        const gameControls = document.getElementById('game-controls');

        const gameResultScreen = document.getElementById('game-result-screen');

        // New element references for split and side bets        const playerHandsDisplay = document.getElementById('player-hands-display'); // JS will need this

        const sideBetResultsEl = document.getElementById('side-bet-results'); // JS will need this

        let splitButton = document.getElementById('split-btn'); // JS will need this - using 'let' to allow reassignment

        // References for side bet input fields (assuming JS will use these IDs)

        const perfectPairsBetInput = document.getElementById('perfect-pairs-bet');

        const twentyOnePlusThreeBetInput = document.getElementById('twenty-one-plus-three-bet');

        const currentPPBetDisplay = document.getElementById('current-pp-bet');

        const current21Plus3BetDisplay = document.getElementById('current-21plus3-bet');





        // --- Game State ---

        let db, auth;

        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

        let currentUser = null;

        let currentPlayerName = "Guest";

        let deck = [];

        let dealerHand = [];

        let playerHand = []; // This will likely be replaced by playerHands for multi-hand support

        let playerHands = []; // To support multiple hands after splitting

        let activeHandIndex = 0; // To track the currently played hand



        let playerChips = 100;

        let currentBet = 0;

        // Add state for side bets

        let perfectPairsBetAmount = 0;

        let twentyOnePlusThreeBetAmount = 0;



        const suits = ['♥', '♦', '♠', '♣'];

        const values = ['2', '3', '4', '5', '6', '7', '8', '9', '10', 'J', 'Q', 'K', 'A'];



        // --- Helper Functions ---

        const sleep = (ms) => new Promise(resolve => setTimeout(resolve, ms));



        // --- Hashing Utilities ---

        const SALT_LENGTH = 16; // Length of the salt in bytes



        function generateSalt() {

            const arr = new Uint8Array(SALT_LENGTH);

            crypto.getRandomValues(arr);

            // Convert byte array to hex string

            return Array.from(arr).map(b => b.toString(16).padStart(2, '0')).join('');

        }



        async function hashPassword(password, salt) {

            const encoder = new TextEncoder();

            // Combine password and salt before hashing

            const data = encoder.encode(password + salt);

            const hashBuffer = await crypto.subtle.digest('SHA-256', data);

            // Convert ArrayBuffer to hex string

            const hashArray = Array.from(new Uint8Array(hashBuffer));

            return hashArray.map(b => b.toString(16).padStart(2, '0')).join('');

        }



        // --- Firebase Initialization and Auth ---

        function initializeFirebase() {

            // Use __firebase_config global variable provided by the environment

            let firebaseConfig = {};

            if (typeof __firebase_config !== 'undefined' && __firebase_config) {

                try {

                    firebaseConfig = JSON.parse(__firebase_config);

                } catch (e) {

                    console.error("Error parsing __firebase_config. Make sure it's a valid JSON string. Falling back to placeholder.", e);

                    if (authSection) authSection.innerHTML = `<p class="text-red-500 text-center">Error: Firebase configuration is invalid. Please check the console.</p>`;

                }

            }



            if (!firebaseConfig.apiKey) {

                firebaseConfig = {

                    apiKey: "AIzaSyBVtq6dAEuybJNmTTv8dXBxTVUgw1t0ZMk",

                    authDomain: "cusumano-website.firebaseapp.com",

                    databaseURL: "https://cusumano-website-default-rtdb.firebaseio.com",

                    projectId: "cusumano-website",

                    storageBucket: "cusumano-website.firebasestorage.app",

                    messagingSenderId: "20051552210",

                    appId: "1:20051552210:web:7eb3b22baa3fec184e4a0b"

                };

                // No warning message here as we are now hardcoding it as a fallback.

            }



            if (!firebaseConfig.apiKey || firebaseConfig.apiKey === "YOUR_API_KEY") {

                console.error("Firebase apiKey is missing or is a placeholder. Firebase will not initialize.");

                if (authSection) authSection.innerHTML = `<p class="text-red-500 text-center">Error: Firebase API key is missing. Please configure Firebase correctly.</p>`;

                return;

            }



            const app = initializeApp(firebaseConfig);

            auth = getAuth(app);

            db = getFirestore(app);



            onAuthStateChanged(auth, async (firebaseUser) => {

                if (firebaseUser) { // A Firebase user is signed in

                    if (firebaseUser.isAnonymous) {

                        if (currentUser && (currentUser.isCustomAuth || currentUser.isLocalGuest)) {

                            console.log("Firebase anonymous user event, but a custom/local session is active. Ignoring Firebase anonymous user.");

                            // Optional: consider signing out the unexpected anonymous user if this state is problematic

                            // signOut(auth).catch(e => console.warn("Failed to sign out stowaway anonymous user", e));

                            return;

                        }

                        // No active custom/local session, so proceed with Firebase anonymous user

                        console.log("Firebase Anonymous user signed in. Setting up session.");

                        const firebaseUserData = await getUserDataFromFirebase(firebaseUser.uid);

                        currentUser = {

                            uid: firebaseUser.uid,

                            displayName: firebaseUserData.displayName || "Guest (Firebase)",

                            isAnonymous: true,

                            isCustomAuth: false,

                            isLocalGuest: false,

                            chips: firebaseUserData.chips !== undefined ? firebaseUserData.chips : 100

                        };

                        currentPlayerName = currentUser.displayName;

                        playerChips = currentUser.chips;

                        showUserProfile(); // This will also call fetchLeaderboard

                    } else {

                        // A non-anonymous Firebase user signed in (e.g., Email/Password, Google etc.)

                        console.warn("A non-anonymous Firebase user signed in, which is not expected by the current custom auth flow.", firebaseUser);

                        if (currentUser && currentUser.isCustomAuth) {

                            console.log("Non-anonymous Firebase user detected, but custom user session is active. Prioritizing custom session.");

                            return;

                        }

                        // If no custom session, this is an unexpected state.

                        // For now, this app doesn't handle this case beyond logging.

                    }

                } else { // No Firebase user is signed in (firebaseUser is null)

                    if (currentUser && (currentUser.isCustomAuth || currentUser.isLocalGuest)) {

                        // A custom or local guest session is active. Firebase being signed out doesn't affect them.

                        console.log("No Firebase user, but a custom/local session is active. Maintaining current session.");

                    } else {

                        // No Firebase user AND no active custom/local session.

                        console.log("No Firebase user and no active custom/local session. Clearing any residual session and showing auth forms.");

                        currentUser = null;

                        currentPlayerName = "Guest";

                        playerChips = 100; // Reset game state for new user/guest

                        showAuthForms(); // This will also call fetchLeaderboard if user proceeds to login/guest play that shows profile

                        // Explicitly clear and then try to fetch leaderboard for the initial auth screen state

                        if (leaderboardDiv) leaderboardDiv.innerHTML = ''; // Clear previous leaderboard

                        fetchLeaderboard(); // Attempt to show leaderboard even on auth screen

                    }

                }

            });



            // Initial check, if no user, show auth forms (onAuthStateChanged will handle this)

            // Call fetchLeaderboard once on initial load if db is available

            if (db) {

                fetchLeaderboard();

            }

        }

       

        async function getUserDataFromFirebase(userId) {

            const userDocRef = doc(db, `artifacts/${appId}/users/${userId}/data`, 'profile');

            const userDoc = await getDoc(userDocRef);

            if (userDoc.exists()) {

                return userDoc.data();

            } else {

                const newUser = {

                    displayName: "Guest (Anonymous)",

                    chips: 100,

                    createdAt: new Date().toISOString(),

                };

                // Only set for Firebase anonymous users if they don't have a profile yet

                await setDoc(userDocRef, newUser, { merge: true });

                return newUser;

            }

        }



        async function fetchLeaderboard() {

            if (!db) {

                console.warn('Firestore not initialized yet. Skipping leaderboard fetch.');

                return;

            }



            try {

                const leaderboardEl = document.getElementById('leaderboard');

                const entriesEl = document.getElementById('leaderboard-entries');

                if (!leaderboardEl || !entriesEl) return;



                // Show leaderboard section

                leaderboardEl.classList.remove('hidden');

                entriesEl.innerHTML = '<li class="text-center text-gray-400">Loading leaderboard...</li>';



                // Get top players from Firestore

                const leaderboardRef = collection(db, 'game_users_custom_auth');

                const q = query(leaderboardRef, firestoreOrderBy('chips', 'desc'), limit(10));

                const querySnapshot = await getDocs(q);

               

                if (querySnapshot.empty) {

                    entriesEl.innerHTML = '<li class="text-center text-gray-400">No players found.</li>';

                    return;

                }



                // Build leaderboard entries

                entriesEl.innerHTML = '';

                let rank = 1;

                querySnapshot.forEach((doc) => {

                    const userData = doc.data();

                    const displayName = userData.displayName || 'Anonymous';

                    const chips = userData.chips || 0;

                   

                    const entryItem = document.createElement('li');

                    entryItem.className = 'flex justify-between items-center p-2 border-b border-gray-700';

                    entryItem.innerHTML = `

                        <span class="font-medium">${rank}. ${displayName}</span>

                        <span class="font-bold text-yellow-400">${chips} chips</span>

                    `;

                    entriesEl.appendChild(entryItem);

                    rank++;

                });

            } catch (error) {

                console.error('Error fetching leaderboard:', error);

                const entriesEl = document.getElementById('leaderboard-entries');

                if (entriesEl) {

                    entriesEl.innerHTML = '<li class="text-center text-red-400">Failed to load leaderboard.</li>';

                }

            }

        }



        async function getCustomUserData(userId) {

            const userDocRef = doc(db, 'game_users_custom_auth', userId);

            const userDoc = await getDoc(userDocRef);

            if (userDoc.exists()) {

                return { id: userDoc.id, ...userDoc.data() };

            }

            return null;

        }



        function showUserProfile() {

            authSection.innerHTML = ''; // Clear auth forms

            authSection.classList.add('hidden');

            userProfile.classList.remove('hidden');

            const profileNameEl = document.getElementById('profile-name');

            const profileChipsEl = document.getElementById('profile-chips');

            if (profileNameEl) profileNameEl.textContent = currentPlayerName;

            if (profileChipsEl) profileChipsEl.textContent = playerChips;

           

            fetchLeaderboard(); // Fetch and display leaderboard when user profile is shown

        }



        /**

         * Authentication UI with tabs for Login, Sign Up, and Guest play.

         */

        function showAuthForms() {

            userProfile.classList.add('hidden');

            authSection.classList.remove('hidden');

            // Reset game state if returning to auth forms from a game

            resetGameStateToDefault();

           

            authSection.innerHTML = `

                <div class="border-b border-gray-600 mb-4">

                    <nav class="-mb-px flex space-x-4" aria-label="Tabs">

                        <button data-tab="login" class="auth-tab-btn whitespace-nowrap py-3 px-1 border-b-2 font-medium text-sm border-indigo-500 text-indigo-400">Login</button>

                        <button data-tab="signup" class="auth-tab-btn whitespace-nowrap py-3 px-1 border-b-2 font-medium text-sm border-transparent text-gray-400 hover:text-gray-200 hover:border-gray-500">Sign Up</button>

                        <button data-tab="guest" class="auth-tab-btn whitespace-nowrap py-3 px-1 border-b-2 font-medium text-sm border-transparent text-gray-400 hover:text-gray-200 hover:border-gray-500">Play as Guest</button>

                    </nav>

                </div>



                <!-- Login Form -->

                <div id="login-tab" class="auth-tab-content active text-left">

                    <div class="space-y-4">

                        <div>

                            <label for="login-username" class="block text-sm font-medium text-gray-300">Username</label>

                            <input type="text" id="login-username" autocomplete="username" class="mt-1 block w-full bg-gray-700 border border-gray-600 rounded-md shadow-sm py-2 px-3 text-white focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm" placeholder="Your username">

                        </div>

                        <div>

                            <label for="login-password" class="block text-sm font-medium text-gray-300">Password</label>

                            <input type="password" id="login-password" autocomplete="current-password" class="mt-1 block w-full bg-gray-700 border border-gray-600 rounded-md shadow-sm py-2 px-3 text-white focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm" placeholder="Your password">

                        </div>

                        <button id="login-btn" class="w-full auth-btn bg-indigo-600 hover:bg-indigo-700 text-white">Login</button>

                        <p id="login-message" class="text-sm text-red-400 h-4"></p>

                    </div>

                </div>



                <!-- Sign Up Form -->

                <div id="signup-tab" class="auth-tab-content text-left">

                    <div class="space-y-4">

                         <div>

                            <label for="signup-name" class="block text-sm font-medium text-gray-300">Display Name</label>

                            <input type="text" id="signup-name" autocomplete="nickname" class="mt-1 block w-full bg-gray-700 border border-gray-600 rounded-md shadow-sm py-2 px-3 text-white focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm" placeholder="How you'll appear to others">

                        </div>

                        <div>

                            <label for="signup-username" class="block text-sm font-medium text-gray-300">Username (for login)</label>

                            <input type="text" id="signup-username" autocomplete="username" class="mt-1 block w-full bg-gray-700 border border-gray-600 rounded-md shadow-sm py-2 px-3 text-white focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm" placeholder="Choose a username">

                        </div>

                        <div>

                            <label for="signup-password" class="block text-sm font-medium text-gray-300">Password</label>

                            <input type="password" id="signup-password" autocomplete="new-password" class="mt-1 block w-full bg-gray-700 border border-gray-600 rounded-md shadow-sm py-2 px-3 text-white focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm" placeholder="6+ characters">

                        </div>

                        <button id="signup-btn" class="w-full auth-btn bg-indigo-600 hover:bg-indigo-700 text-white">Create Account</button>

                         <p id="signup-message" class="text-sm text-red-400 h-4"></p>

                    </div>

                </div>

               

                <!-- Guest Form -->

                 <div id="guest-tab" class="auth-tab-content text-left">

                     <p class="text-gray-400 mb-4">Play without an account. Your progress will be temporary.</p>

                     <button id="guest-play-btn" class="w-full auth-btn bg-green-600 hover:bg-green-700 text-white">Play as Guest</button>

                     <p id="guest-message" class="text-sm text-red-400 h-4 mt-2"></p>

                </div>

            `;

           

            // Add event listeners for the new auth UI

            const tabs = authSection.querySelectorAll('.auth-tab-btn');

            const contents = authSection.querySelectorAll('.auth-tab-content');



            tabs.forEach(tab => {

                tab.addEventListener('click', () => {

                    tabs.forEach(item => {

                        item.classList.remove('border-indigo-500', 'text-indigo-400');

                        item.classList.add('border-transparent', 'text-gray-400', 'hover:text-gray-200', 'hover:border-gray-500');

                    });

                    tab.classList.add('border-indigo-500', 'text-indigo-400');

                    tab.classList.remove('border-transparent', 'text-gray-400', 'hover:text-gray-200', 'hover:border-gray-500');

                   

                    contents.forEach(content => content.classList.remove('active'));

                    document.getElementById(`${tab.dataset.tab}-tab`).classList.add('active');

                });

            });



            document.getElementById('login-btn').addEventListener('click', async () => {

                const username = document.getElementById('login-username').value;

                const password = document.getElementById('login-password').value;

                const messageEl = document.getElementById('login-message');

                messageEl.textContent = ''; // Clear previous messages



                if (!username || !password) {

                    messageEl.textContent = "Please enter username and password.";

                    return;

                }

                try {

                    messageEl.textContent = 'Logging in...';

                    await handleCustomLogin(username, password);

                    // On success, handleCustomLogin should update state and call showUserProfile()

                } catch (error) {

                    console.error("Custom login failed:", error);

                    messageEl.textContent = error.message || "Login failed. Please check your credentials.";

                }

            });



            document.getElementById('signup-btn').addEventListener('click', async () => {

                const displayName = document.getElementById('signup-name').value;

                const username = document.getElementById('signup-username').value;

                const password = document.getElementById('signup-password').value;

                const messageEl = document.getElementById('signup-message');

                messageEl.textContent = ''; // Clear previous messages



                if (!displayName || !username || !password) {

                    messageEl.textContent = "Please fill out all fields.";

                    return;

                }

                if (password.length < 6) {

                    messageEl.textContent = "Password should be at least 6 characters.";

                    return;

                }

                try {

                    messageEl.textContent = 'Creating account...';

                    await handleCustomSignUp(username, password, displayName);

                    // On success, handleCustomSignUp should update state and call showUserProfile()

                } catch (error) {

                    console.error("Custom sign up failed:", error);

                    messageEl.textContent = error.message || "Sign up failed. Username might be taken or an error occurred.";

                }

            });

           

            document.getElementById('guest-play-btn').addEventListener('click', async () => {

                const messageEl = document.getElementById('guest-message');

                if (messageEl) messageEl.textContent = '';



                console.log("Starting local guest mode.");

                currentUser = {

                    uid: 'local_guest_' + Date.now(),

                    displayName: 'Guest (Local Demo)',

                    isLocalGuest: true,

                    isAnonymous: false,

                    isCustomAuth: false,

                    chips: 100

                };

                currentPlayerName = currentUser.displayName;

                playerChips = currentUser.chips; // Initialize playerChips for guest

               

                showUserProfile();

                if (messageEl) messageEl.textContent = "Playing as Guest (Demo Mode). Progress is not saved.";

                // fetchLeaderboard(); // showUserProfile calls this already

            });

        }



        // --- Game Logic ---

        function resetGameStateToDefault() {

            deck = [];

            dealerHand = [];

            playerHands = [];

            activeHandIndex = 0;

            currentBet = 0;

            perfectPairsBetAmount = 0;

            twentyOnePlusThreeBetAmount = 0;

       

            if (dealerCardsEl) dealerCardsEl.innerHTML = '';

            if (playerHandsDisplay) playerHandsDisplay.innerHTML = ''; // Clear multi-hand display

            if (sideBetResultsEl) {

                sideBetResultsEl.innerHTML = '';

                sideBetResultsEl.classList.add('hidden');

            }

       

            // Hide game controls, result screen, show betting (or main menu if applicable)

            if (gameControls) gameControls.classList.add('hidden');

            if (bettingControls) bettingControls.classList.remove('hidden');

            if (gameResultScreen) gameResultScreen.classList.remove('active');



            const chipsDisplay = document.getElementById('player-chips');

            if (chipsDisplay) chipsDisplay.textContent = playerChips;

            const currentBetDisplay = document.getElementById('current-bet');

            if (currentBetDisplay) currentBetDisplay.textContent = currentBet;

            // Reset side bet displays

            if (currentPPBetDisplay) currentPPBetDisplay.textContent = '0';

            if (perfectPairsBetInput) perfectPairsBetInput.value = '0';

            if (current21Plus3BetDisplay) current21Plus3BetDisplay.textContent = '0';

            if (twentyOnePlusThreeBetInput) twentyOnePlusThreeBetInput.value = '0';

            if (splitButton) splitButton.classList.add('hidden');

        }

       

        async function startNewHand() {

            toggleControls(false);

            if (currentBet === 0) { // Main bet must be placed

                alert("Please place a main bet first.");

                toggleControls(false);

                return;

            }

           

            playerHands = [{

                cards: [], bet: currentBet, score: 0, isStood: false, isBust: false,

                isBlackjack: false, canSplit: false, id: "hand-0", element: null,

                scoreElement: null, statusElement: null, resultMessage: "", payout: 0,

                isAceSplit: false // For handling Ace split rules

            }];

            activeHandIndex = 0;

            dealerHand = [];

            if (dealerCardsEl) dealerCardsEl.innerHTML = '';

            playerHandsDisplay.innerHTML = ''; // Clear for new hand(s)

            if (sideBetResultsEl) {

                sideBetResultsEl.innerHTML = '';

                sideBetResultsEl.classList.add('hidden');

            }

            createDeck();



            // Create and initialize the first hand display

            createPlayerHandDisplay(playerHands[activeHandIndex]);

           

            // Deal cards to player and dealer with animation

            await dealCardToPlayer(playerHands[activeHandIndex]); // First card to player

            await sleep(300);

           

            await dealCardToDealer(false); // First card to dealer (face up)

            await sleep(300);

           

            await dealCardToPlayer(playerHands[activeHandIndex]); // Second card to player

            await sleep(300);

           

            await dealCardToDealer(true); // Second card to dealer (face down)

            await sleep(300);

           

            // Evaluate side bets if applicable

            if (perfectPairsBetAmount > 0 || twentyOnePlusThreeBetAmount > 0) {

                evaluateSideBets();

            }

           

            // Update scores and UI, check for split option

            updateScoresAndUI();

           

            // Show game controls

            toggleControls(true);

           

            // Check for blackjack in the initial hand

            const currentActiveHand = playerHands[activeHandIndex];

            if (currentActiveHand.score === 21 && currentActiveHand.cards.length === 2) {

                currentActiveHand.isBlackjack = true;

                currentActiveHand.statusElement.textContent = "Blackjack!";

                currentActiveHand.statusElement.classList.add("text-green-400", "font-bold");

                await sleep(1000);

                stand(); // Move to dealer's turn

            }

        }

       

        // Constants for side bet payouts

        const PERFECT_PAIRS_PAYOUTS = {

            perfect: 25, // Same suit, same rank (e.g., ♥K ♥K)

            colored: 12, // Same color, same rank (e.g., ♥K ♦K)

            mixed: 6     // Different color, same rank (e.g., ♥K ♠K)

        };

       

        const TWENTY_ONE_PLUS_THREE_PAYOUTS = {

            suitedTrips: 100,  // Three of a kind, same suit (e.g., ♥A ♥A ♥A)

            straightFlush: 40, // Three consecutive cards, same suit

            threeOfAKind: 30,  // Three of a kind, mixed suits

            straight: 10,      // Three consecutive cards, mixed suits

            flush: 5           // Three cards of the same suit

        };

       

        function createDeck() {

            deck = [];

            for (const suit of suits) {

                for (const value of values) {

                    deck.push({ suit, value });

                }

            }

            // Shuffle the deck

            for (let i = deck.length - 1; i > 0; i--) {

                const j = Math.floor(Math.random() * (i + 1));

                [deck[i], deck[j]] = [deck[j], deck[i]];

            }

        }

       

        function calculateScore(hand) {

            let score = 0;

            let aceCount = 0;

            hand.forEach(card => {

                if (card.value === 'A') {

                    aceCount++;

                    score += 11; // Initially count Ace as 11

                } else if (['K', 'Q', 'J'].includes(card.value)) {

                    score += 10;

                } else {

                    score += parseInt(card.value);

                }

            });

            // Adjust for Aces if score is over 21

            while (score > 21 && aceCount > 0) {

                score -= 10;

                aceCount--;

            }

            return score;

        }

       

        function updateScoresAndUI() {

            playerHands.forEach((hand, index) => {

                hand.score = calculateScore(hand.cards);

                const handScoreEl = document.getElementById(`player-score`);

                if (handScoreEl) handScoreEl.textContent = hand.score;

            });

            dealerHand.score = calculateScore(dealerHand.cards);

            if (dealerScoreEl) dealerScoreEl.textContent = dealerHand.score;

        }

       

        function createPlayerHandDisplay(hand) {

            const handContainer = document.createElement('div');

            handContainer.className = 'player-hand border p-2 rounded';

            handContainer.id = hand.id;

           

            const handTitle = document.createElement('div');

            handTitle.className = 'hand-label';

            handTitle.textContent = `Hand ${activeHandIndex + 1}: `;

           

            const scoreDisplay = document.createElement('div');

            scoreDisplay.className = 'player-score text-lg';

            scoreDisplay.textContent = `Score: ${hand.score}`;

           

            const cardsContainer = document.createElement('div');

            cardsContainer.className = 'player-cards flex space-x-2 mt-2 min-h-[100px]';

            cardsContainer.id = `cards-${hand.id}`;

           

            hand.cards.forEach(card => {

                const cardElement = document.createElement('div');

                cardElement.className = 'card';

                cardElement.innerHTML = `

                    <div class="card-face">

                        <div class="value">${card.value}</div>

                        <div class="suit">${card.suit}</div>

                    </div>

                    <div class="card-back"></div>

                `;

                cardsContainer.appendChild(cardElement);

            });

           

            handContainer.appendChild(handTitle);

            handContainer.appendChild(scoreDisplay);

            handContainer.appendChild(cardsContainer);

           

            playerHandsDisplay.appendChild(handContainer);

            hand.element = handContainer;

            hand.scoreElement = scoreDisplay;

            hand.cardsContainer = cardsContainer;

        }

       

        async function dealCardToPlayer(hand) {

            if (deck.length === 0) {

                console.warn("Deck is empty, cannot deal card.");

                return;

            }

            const card = deck.pop();

            hand.cards.push(card);

            const cardElement = document.createElement('div');

            cardElement.className = 'card dealing';

            cardElement.innerHTML = `

                <div class="card-face">

                    <div class="value">${card.value}</div>

                    <div class="suit">${card.suit}</div>

                </div>

                <div class="card-back"></div>

            `;

            hand.cardsContainer.appendChild(cardElement);

            await sleep(300);

            cardElement.classList.remove('dealing');

        }

       

        async function dealCardToDealer(faceUp) {

            if (deck.length === 0) {

                console.warn("Deck is empty, cannot deal card.");

                return;

            }

            const card = deck.pop();

            dealerHand.cards.push(card);

            const cardElement = document.createElement('div');

            cardElement.className = 'card dealing';

            cardElement.innerHTML = `

                <div class="card-face">

                    <div class="value">${card.value}</div>

                    <div class="suit">${card.suit}</div>

                </div>

                <div class="card-back"></div>

            `;

            dealerCardsEl.appendChild(cardElement);

            await sleep(300);

            cardElement.classList.remove('dealing');

           

            // If dealer's first card is an Ace, prompt for insurance

            if (faceUp && card.value === 'A') {

                // Implement insurance logic here if desired

            }

        }

       

        function toggleControls(showGameControls) {

            if (showGameControls) {

                gameControls.classList.remove('hidden');

                bettingControls.classList.add('hidden');

            } else {

                gameControls.classList.add('hidden');

                bettingControls.classList.remove('hidden');

            }

        }

       

        // --- Event Listeners Setup ---

        function setupEventListeners() {

            // Game Buttons

            const placeBetBtn = document.getElementById('place-bet-btn');

            const hitBtn = document.getElementById('hit-btn');

            const standBtn = document.getElementById('stand-btn');

            const playAgainBtn = document.getElementById('play-again-btn');

            const returnMenuBtn = document.getElementById('return-menu-btn');

            splitButton = document.getElementById('split-btn');

           

            // Main Menu Buttons

            const playBtn = document.getElementById('play-btn');

            const logoutBtn = document.getElementById('logout-btn');

           

            // Initialize play button

            if (playBtn) {

                playBtn.addEventListener('click', () => {

                    mainMenu.classList.add('hidden');

                    gameCanvas.classList.remove('hidden');

                });

            }

           

            // Initialize logout button

            if (logoutBtn) {

                logoutBtn.addEventListener('click', async () => {

                    // Sign out from Firebase auth if applicable

                    if (auth && !currentUser?.isCustomAuth && !currentUser?.isLocalGuest) {

                        await signOut(auth);

                    }

                    // Reset user session state

                    currentUser = null;

                    currentPlayerName = "Guest";

                    playerChips = 100;

                    showAuthForms();

                });

            }

           

            // Game controls

            if (placeBetBtn) placeBetBtn.addEventListener('click', placeBet);

            if (hitBtn) hitBtn.addEventListener('click', hit);

            if (standBtn) standBtn.addEventListener('click', stand);

            if (playAgainBtn) {

                playAgainBtn.addEventListener('click', () => {

                    resetGameStateToDefault();

                    toggleControls(false); // Show betting controls

                    if (gameResultScreen) gameResultScreen.classList.remove('active');

                    if (sideBetResultsEl) sideBetResultsEl.classList.add('hidden');

                });

            }

           

            // Return to main menu button

            if (returnMenuBtn) {

                returnMenuBtn.addEventListener('click', () => {

                    resetGameStateToDefault();

                    gameCanvas.classList.add('hidden');

                    mainMenu.classList.remove('hidden');

                    if (gameResultScreen) gameResultScreen.classList.remove('active');

                });

            }

           

            // Split button

            if (splitButton) {

                splitButton.addEventListener('click', handleSplit);

                splitButton.disabled = true; // Initially disabled

                splitButton.classList.add('hidden');

            }

        }

       

        function placeBet() {

            // Get bet amount from inputs

            const betInput = document.getElementById('bet-amount');

            const mainBet = parseInt(betInput.value) || 0;

           

            // Get side bet amounts if they exist

            const ppBetInput = document.getElementById('perfect-pairs-bet');

            const bet21Plus3Input = document.getElementById('twenty-one-plus-three-bet');

           

            perfectPairsBetAmount = ppBetInput ? (parseInt(ppBetInput.value) || 0) : 0;

            twentyOnePlusThreeBetAmount = bet21Plus3Input ? (parseInt(bet21Plus3Input.value) || 0) : 0;

           

            // Calculate total bet

            const totalBet = mainBet + perfectPairsBetAmount + twentyOnePlusThreeBetAmount;

           

            // Validate bets

            if (mainBet <= 0) {

                alert("Please enter a valid main bet amount.");

                return;

            }

           

            if (perfectPairsBetAmount < 0 || twentyOnePlusThreeBetAmount < 0) {

                alert("Side bets cannot be negative.");

                return;

            }

           

            if (totalBet > playerChips) {

                alert("You don't have enough chips for this bet.");

                return;

            }

           

            // Update game state

            currentBet = mainBet;

            playerChips -= totalBet;

           

            // Update UI

            const chipsDisplay = document.getElementById('player-chips');

            if (chipsDisplay) chipsDisplay.textContent = playerChips;

           

            const currentBetDisplay = document.getElementById('current-bet');

            if (currentBetDisplay) currentBetDisplay.textContent = currentBet;

           

            if (currentPPBetDisplay) currentPPBetDisplay.textContent = perfectPairsBetAmount;

            if (current21Plus3BetDisplay) current21Plus3BetDisplay.textContent = twentyOnePlusThreeBetAmount;

           

            // Start the game

            startNewHand();

        }

       

        // Initialize game

        document.addEventListener('DOMContentLoaded', () => {

            console.log("DOM content loaded");

            initializeFirebase();

            setupEventListeners(); // Setup all game interaction listeners

            resetGameStateToDefault(); // Ensure clean state on load

            toggleControls(false); // Show betting controls initially

        });

    </script>

</body>

</html>